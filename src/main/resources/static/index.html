<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ollama Chat Demo</title>
    <link rel="stylesheet" href="/style.css">
    <script>
        let currentChat = [];
        let currentChatId = null; // Track the loaded chat's ID

        async function sendMessageJSONFile() {
            const input = document.getElementById('chatInput');
            const question = input.value.trim();
            if (!question) return;
            appendMessage(question, 'user');
            currentChat.push({ text: question, sender: 'user' });
            input.value = '';
            scrollToBottom();

            // Add processing animation
            const chat = document.getElementById('chatMessages');
            const processingDiv = document.createElement('div');
            processingDiv.className = 'message ollama';
            processingDiv.id = 'processingMessage';
            processingDiv.innerHTML = '<span class="dot-anim"><span></span><span></span><span></span></span>';
            chat.appendChild(processingDiv);
            scrollToBottom();

            try {
                const response = await fetch('/v1/ask_ollama/' + encodeURIComponent(question), {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                if(!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const text = await response.text();
                // Remove processing animation
                processingDiv.remove();
                appendMessage(text, 'ollama');
                currentChat.push({ text: text, sender: 'ollama' });
                scrollToBottom();
            } catch (e) {
                processingDiv.remove();
                appendMessage('Error: Could not reach Ollama service.', 'ollama');
                currentChat.push({ text: 'Error: Could not reach Ollama service.', sender: 'ollama' });
                scrollToBottom();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const question = input.value.trim();
            if (!question) return;
            appendMessage(question, 'user');
            currentChat.push({ text: question, sender: 'user' });
            input.value = '';
            scrollToBottom();

            // Add processing animation
            const chat = document.getElementById('chatMessages');
            const processingDiv = document.createElement('div');
            processingDiv.className = 'message ollama';
            processingDiv.id = 'processingMessage';
            processingDiv.innerHTML = '<span class="dot-anim"><span></span><span></span><span></span></span>';
            chat.appendChild(processingDiv);
            scrollToBottom();

            try {
                const response = await fetch('/v1/ask_ollama_json_file/' + encodeURIComponent(question), {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                // Get the JSON file as a Blob
                const blob = await response.blob();

                // Remove processing animation
                processingDiv.remove();

                // Create a download link for the JSON file
                const fileName = `ollama_response_${Date.now()}.json`;
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                link.innerText = 'Download Ollama JSON Response';
                link.style.display = 'inline-block';
                link.style.marginTop = '8px';

                // Show a message and the download link
                const msgDiv = document.createElement('div');
                msgDiv.className = 'message ollama';
                msgDiv.innerText = 'Ollama response is ready. ';
                msgDiv.appendChild(link);
                chat.appendChild(msgDiv);

                // Save only the download link info in chat history
                currentChat.push({
                    text: `Ollama response is ready. [${fileName}]`,
                    containsFileLink: true,
                    sender: 'ollama',
                    fileUrl: url,
                    fileName: fileName
                });
                scrollToBottom();
            } catch (e) {
                processingDiv.remove();
                appendMessage('Error: Could not reach Ollama service.', 'ollama');
                currentChat.push({ text: 'Error: Could not reach Ollama service.', sender: 'ollama' });
                scrollToBottom();
            }
        }

        function appendMessage(text, sender) {
            const chat = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ' + sender;
            msgDiv.innerText = text;
            chat.appendChild(msgDiv);
        }

        function scrollToBottom() {
            const chat = document.getElementById('chatMessages');
            chat.scrollTop = chat.scrollHeight;
        }

        function showChatNameModal(onSave) {
            const modal = document.getElementById('chatNameModal');
            const input = document.getElementById('chatNameInput');
            const saveBtn = document.getElementById('chatNameSave');
            const cancelBtn = document.getElementById('chatNameCancel');
            input.value = '';
            modal.style.display = 'flex';
            input.focus();

            function close() {
                modal.style.display = 'none';
                saveBtn.onclick = null;
                cancelBtn.onclick = null;
            }

            saveBtn.onclick = () => {
                onSave(input.value.trim());
                close();
            };
            cancelBtn.onclick = close;
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    saveBtn.onclick();
                }
                if (e.key === 'Escape') {
                    close();
                }
            };
        }

        function saveChat() {
            if (currentChat.length === 0) return;
            let history = JSON.parse(localStorage.getItem('ollama_chat_history') || '[]');
            const timestamp = new Date().toLocaleString();

            if (currentChatId) {
                // Update existing chat without asking for name
                const idx = history.findIndex(c => c.id === currentChatId);
                if (idx !== -1) {
                    history[idx].messages = currentChat.slice();
                    // Keep the existing name
                }
                localStorage.setItem('ollama_chat_history', JSON.stringify(history));
                loadChatHistory();
                alert('Chat saved!');
            } else {
                // New chat: ask for name
                showChatNameModal(function(userName) {
                    let chatName = userName ? userName : 'Chat ' + timestamp;
                    const chatId = 'chat_' + Date.now();
                    const chatData = { id: chatId, name: chatName, messages: currentChat.slice() };
                    history.unshift(chatData);
                    currentChatId = chatId;
                    localStorage.setItem('ollama_chat_history', JSON.stringify(history));
                    loadChatHistory();
                    alert('Chat saved!');
                });
            }
        }

        function loadChatHistory() {
            const history = JSON.parse(localStorage.getItem('ollama_chat_history') || '[]');
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            if (history.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'history-item';
                empty.innerText = 'No saved chats';
                empty.style.color = '#aaa';
                empty.style.cursor = 'default';
                list.appendChild(empty);
                return;
            }
            history.forEach(chat => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.style.display = 'flex';
                item.style.justifyContent = 'space-between';
                item.style.alignItems = 'center';

                const nameSpan = document.createElement('span');
                nameSpan.innerText = chat.name;
                nameSpan.style.flex = '1';
                nameSpan.style.cursor = 'pointer';
                nameSpan.onclick = () => {
                    loadChat(chat.id);
                    toggleDropdown(false);
                };

                // Edit button
                const editBtn = document.createElement('button');
                editBtn.title = 'Edit chat name';
                editBtn.className = 'icon-btn';
                editBtn.style.marginLeft = '8px';
                editBtn.innerHTML = `
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z" stroke="#1976d2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    </svg>
                `;
                editBtn.onclick = (e) => {
                    e.stopPropagation();
                    showEditChatNameModal(chat.id, chat.name);
                };

                // Delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.title = 'Delete chat';
                deleteBtn.className = 'icon-btn';
                deleteBtn.style.marginLeft = '8px';
                deleteBtn.innerHTML = `
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m2 0v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6h16zM10 11v6M14 11v6" stroke="#1976d2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                `;
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteChat(chat.id);
                };

                item.appendChild(nameSpan);
                item.appendChild(editBtn);
                item.appendChild(deleteBtn);
                list.appendChild(item);
            });
        }

        function deleteChat(chatId) {
            let history = JSON.parse(localStorage.getItem('ollama_chat_history') || '[]');
            history = history.filter(c => c.id !== chatId);
            localStorage.setItem('ollama_chat_history', JSON.stringify(history));
            loadChatHistory();
        }

        function loadChat(chatId) {
            const history = JSON.parse(localStorage.getItem('ollama_chat_history') || '[]');
            const chat = history.find(c => c.id === chatId);
            if (!chat) return;
            currentChat = chat.messages.slice();
            currentChatId = chatId; // Set the current chat ID
            const chatBox = document.getElementById('chatMessages');
            chatBox.innerHTML = '';
            currentChat.forEach(msg => {
                //check if the message contains a file link and append accordingly
                if (msg.containsFileLink) {
                    const link = document.createElement('a');
                    link.href = msg.fileUrl;
                    link.download = msg.fileName;
                    link.innerText = 'Download Ollama JSON Response';
                    link.style.display = 'inline-block';
                    link.style.marginTop = '8px';

                    // Show a message and the download link
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'message ollama';
                    msgDiv.innerText = 'Ollama response is ready. ';
                    msgDiv.appendChild(link);
                    chatBox.appendChild(msgDiv);
                }else{
                    appendMessage(msg.text, msg.sender);
                }
            });
            scrollToBottom();
        }

        function toggleDropdown(forceState) {
            const dropdown = document.getElementById('historyList');
            if (forceState === undefined) {
                dropdown.classList.toggle('show');
            } else {
                dropdown.classList[forceState ? 'add' : 'remove']('show');
            }
        }

        function displayInitialMessage() {
            const chatBox = document.getElementById('chatMessages');
            chatBox.innerHTML = '';
            const initialMessage = document.createElement('div');
            initialMessage.className = 'message ollama';
            initialMessage.innerHTML = 'Welcome to Ollama Chat!<br>Type your message below and press Enter or click Send.';
            chatBox.appendChild(initialMessage);
            scrollToBottom();
        }

        function showEditChatNameModal(chatId, currentName) {
            const modal = document.getElementById('chatNameModal');
            const input = document.getElementById('chatNameInput');
            const saveBtn = document.getElementById('chatNameSave');
            const cancelBtn = document.getElementById('chatNameCancel');
            input.value = currentName || '';
            modal.style.display = 'flex';
            input.focus();

            function close() {
                modal.style.display = 'none';
                saveBtn.onclick = null;
                cancelBtn.onclick = null;
                input.onkeydown = null;
            }

            saveBtn.onclick = () => {
                const newName = input.value.trim();
                if (newName) {
                    let history = JSON.parse(localStorage.getItem('ollama_chat_history') || '[]');
                    const idx = history.findIndex(c => c.id === chatId);
                    if (idx !== -1) {
                        history[idx].name = newName;
                        localStorage.setItem('ollama_chat_history', JSON.stringify(history));
                        loadChatHistory();
                    }
                }
                close();
            };
            cancelBtn.onclick = close;
            input.onkeydown = (e) => {
                if (e.key === 'Enter') saveBtn.onclick();
                if (e.key === 'Escape') close();
            };
        }

        window.onload = function() {
            document.getElementById('chatInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const useJson = document.getElementById('jsonResponseCheckbox').checked;
                    useJson ? sendMessage() : sendMessageJSONFile();
                }
            });
            document.getElementById('sendBtn').addEventListener('click', function() {
                const useJson = document.getElementById('jsonResponseCheckbox').checked;
                useJson ? sendMessage() : sendMessageJSONFile();
            });
            document.getElementById('saveBtn').addEventListener('click', saveChat);
            document.getElementById('historyBtn').addEventListener('click', function(e) {
                toggleDropdown();
                e.stopPropagation();
            });
            loadChatHistory();
            document.addEventListener('click', function() {
                toggleDropdown(false);
            });
            document.getElementById('historyList').addEventListener('click', function(e) {
                e.stopPropagation();
            });
            document.getElementById('clearBtn').addEventListener('click', function() {
                document.getElementById('chatMessages').innerHTML = '';
                currentChat = [];
                currentChatId = null;
                displayInitialMessage();
            });
            displayInitialMessage();
        }
    </script>
</head>
<body>
<div class="chat-container">
    <div class="chat-header">
        <!-- Inside .chat-header -->
        <div class="history-dropdown">
            <button class="icon-btn" id="historyBtn" aria-label="Chat History">
                <!-- History (menu) icon SVG -->
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                    <rect y="4" width="24" height="2" rx="1" fill="#1976d2"/>
                    <rect y="11" width="24" height="2" rx="1" fill="#1976d2"/>
                    <rect y="18" width="24" height="2" rx="1" fill="#1976d2"/>
                </svg>
                <span class="tooltip">Chat History</span>
            </button>
            <div class="history-list" id="historyList"></div>
        </div>
        <span class="header-title">Ollama Chat (Cap1)</span>
        <button class="icon-btn" id="saveBtn" aria-label="Save Chat">
            <!-- Save (floppy disk) icon SVG -->
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                <path d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7l-4-4zM12 19a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm2-10H6V5h8v4z"
                      fill="#1976d2"/>
            </svg>
            <span class="tooltip">Save Chat</span>
        </button>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-area">
        <div class="input-checkbox-wrapper">
            <input type="text" id="chatInput" class="chat-input" placeholder="Type your message..." autocomplete="off"/>
            <input type="checkbox" id="jsonResponseCheckbox" title="Receive JSON File as Response">
        </div>
        <button id="clearBtn" class="icon-btn" aria-label="Clear Chat" style="background:#e53935; margin-left:10px;">
            <!-- Trash icon SVG -->
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m2 0v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6h16zM10 11v6M14 11v6"
                      stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span class="tooltip">Clear Chat</span>
        </button>
        <button id="sendBtn" class="send-btn">Send</button>
    </div>
</div>
<div id="chatNameModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3>Name your chat (optional)</h3>
        <input id="chatNameInput" type="text" placeholder="Enter chat name..."/>
        <div class="modal-actions">
            <button id="chatNameCancel">Cancel</button>
            <button id="chatNameSave">Save</button>
        </div>
    </div>
</div>
</body>
</html>